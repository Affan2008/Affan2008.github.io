var isMobile=false;var postRunDone=false;var gameGuid=null;var stretchMode=false;var gameStarted=false;var startupTimeStr="";var firebaseApp=null;var firebaseStorage=null;var singleGameBlob=null;var singleGameReadCounts=false;var singleGameReadLedger=false;var loadProgressFrac=0;var gameDownloadProgressFrac=0;var latestLevelInfoStr=null;var levelSelectMenuShowing=false;window.adsbygoogle=window.adsbygoogle||[];const adBreak=adConfig=function(o){adsbygoogle.push(o);}
var prerollDone=true;window.addEventListener('DOMContentLoaded',domContentLoaded);window.addEventListener('load',function(){console.log("Load event received");let guid=getGameGuidString();if(guid!=""){console.log("Found GUID, starting early download route");initFirebaseBasic();downloadLinkedGame(guid);}
if(inIframe()){document.addEventListener('click',ev=>{let canvas=document.getElementById('canvas');if(canvas){canvas.focus();}});}});function inIframe(){try{return window.self!==window.top;}catch(e){return true;}}
function updateLoadProgress(){let guid=getGameGuidString();let progressMaxValue=guid==""?100:200;let progressElement=document.getElementById('progress');if(progressElement){progressElement.value=Math.round((loadProgressFrac+gameDownloadProgressFrac)*100);progressElement.max=progressMaxValue;}
if(loadProgressFrac>=1&&(guid==""||gameDownloadProgressFrac>=1)){console.log("Loading done");showPlayButton();}}
function downloadLinkedGame(guid){console.log("Downloading linked game "+guid);let sref=firebaseStorage.ref(`games/${guid}`);const fakeProgress=function(){if(gameDownloadProgressFrac<1){gameDownloadProgressFrac+=0.1;if(gameDownloadProgressFrac>0.95){gameDownloadProgressFrac=0.95;}else{setTimeout(fakeProgress,200);}
updateLoadProgress();}};fakeProgress();sref.getDownloadURL().then((url)=>{let xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onload=(event)=>{let blob=xhr.response;singleGameBlob=blob;gameDownloadProgressFrac=1;updateLoadProgress();};xhr.onerror=function(){showLoadError("Unable to load game");};xhr.open('GET',url);xhr.send();}).catch((error)=>{showLoadError("Unable to load game");});}
var showPlayButtonAttempts=0
function showPlayButton(){if(!postRunDone){showPlayButtonAttempts++;if(showPlayButtonAttempts==10){alert("Could not initialize the game. Try to reload the page");return;}
setTimeout(showPlayButton,250);console.log("Not ready to show play button yet...");return;}
console.log("Showing play button");var parent=document.getElementById("progress_or_play");parent.style.lineHeight='1em';let accepted=false;try{accepted=localStorage.getItem('accepted-pp');}catch(err){}
if(accepted){parent.innerHTML=`
    <a class="overlay_button" id="play_button" href="#" onclick="checkStartGame(); return false;">
    Play
    </a>
    `;}else{parent.innerHTML=`
    <p id="terms_p">
    By playing Fancade you agree to<br/>occasional ads and the <a href="https://www.fancade.com/privacy/" target="_blank" >Privacy Policy</a>
    </p>
    <a class="overlay_button" id="play_button" href="#" onclick="checkStartGame(); return false;">
    OK
    </a>
    `;}}
function domContentLoaded(){console.log("DOM content loaded event received");let canvas=document.getElementById('canvas');canvas.addEventListener("contextmenu",stopContextMenu);if(!postRunDone){resizeCanvas(false);}
let vanityUrl=getMeta("fancade:vanity_url");if(vanityUrl.length>0){history.replaceState({},'',vanityUrl);}
window.addEventListener('blur',ev=>setGameFocus(false));window.addEventListener('focus',ev=>setGameFocus(true));canvas.onpointerdown=beginPointerDrag;canvas.onpointerup=endPointerDrag;}
function beginPointerDrag(e){let canvas=document.getElementById('canvas');canvas.setPointerCapture(e.pointerId);}
function endPointerDrag(e){let canvas=document.getElementById('canvas');canvas.releasePointerCapture(e.pointerId);}
function setGameFocus(f){if(postRunDone){console.log("Setting game focus "+f);Module.ccall('set_game_focus','v',['number'],[f]);}}
function toggleStretchMode(){stretchMode=!stretchMode;resizeCanvas(true);}
function canBeGameGuid(str){return str&&str.match('([A-F]|[0-9]){16}');}
function getGameGuidString(){if(gameGuid!=null){return gameGuid;}
gameGuid="";let str=window.location.href;if(str){for(let i=0;i<=str.length-16;i++){let subStr=str.substr(i,16);if(canBeGameGuid(subStr)){gameGuid=subStr;}}}
if(gameGuid==""){str=getMeta("fancade:guid");if(canBeGameGuid(str)){gameGuid=str;}}
if(gameGuid==""){str=parseUrlArgument("override_guid");if(canBeGameGuid(str)){gameGuid=str;}}
console.log("Got GUID string '"+gameGuid+"'");return gameGuid;}
function getMeta(metaName){const metas=document.getElementsByTagName('meta');for(let i=0;i<metas.length;i++){if(metas[i].getAttribute('name')===metaName){return metas[i].getAttribute('content');}}
return'';}
function deepLinkedGameStarted(){hideOverlayGradient();}
function getCSSRgb(color){return`rgb(${Math.round(color[0])}, ${Math.round(color[1])}, ${Math.round(color[2])})`;}
let lastGradientStyleStr="";let lastDeepLinkLoadFraction=0;function getGradientStr(frac){let fromColor=[frac*0x70,frac*0xe1,frac*0xfd];let toColor=[frac*0x00,frac*0xa2,frac*0xff];let str=`linear-gradient(135deg, ${getCSSRgb(fromColor)}, ${getCSSRgb(toColor)})`
return str;}
function setDeepLinkLoadingFraction(frac){let gradient=document.getElementById('gradient');let str=getGradientStr(frac);if(lastGradientStyleStr!=str){lastGradientStyleStr=str;gradient.style.backgroundImage=str;}
if(lastDeepLinkLoadFraction<0.95&&frac>=0.95){console.log("Showing long time loading message");gradient.innerHTML=`
    <div class="middle center">
      <p class="deeplink_message">It is taking longer than expected to load this game...</p>
      <a class="overlay_button" id="play_button" href="https://play.fancade.com" >Go to Fancade</a>  
    </div>
    `;}else if(lastDeepLinkLoadFraction<0.01&&frac>=0.01){console.log("Showing loading message");gradient.innerHTML=`
    <div class="middle center">
      <p class="deeplink_message">Loading...</p>
    </div>
    `;}
lastDeepLinkLoadFraction=frac;}
function startLevel(index){Module.ccall("level_select_menu_start_level","v",["number"],[index]);levelSelectMenuShowing=false;}
function getLevelMenuColumns(itemsWidth,levelCount){let columns=2;let foundColumn=false;let maxColumns=Math.min(20,Math.round(itemsWidth/110.0));for(let i=2;i<=maxColumns;i++){if((levelCount%i)==0){columns=i;foundColumn=true;}}
if(!foundColumn){for(let i=2;i<=maxColumns;i++){if(((levelCount+1)%i)==0){columns=i;}}}
return columns;}
function showLevelSelectMenu(levelInfoStr){latestLevelInfoStr=levelInfoStr;levelSelectMenuShowing=true;var gradient=document.getElementById('gradient');let itemsHtml="";let levelCount=0;if(levelInfoStr){let infoStrs=levelInfoStr.split(";");infoStrs.forEach((str,i)=>{if(str==""){return;}
let arr=str.split(",");let levelName=arr.length>0?arr[0]:"";let imagePath=arr.length>1?arr[1]:"";let completed=arr.length>2?arr[2]:"0";let checkmarkStr="";if(completed!="0"){checkmarkStr=`<span class="level_checkmark">\u2713</span>`;}
itemsHtml+=`
      <a class="grid_element_center" href="#" onclick="startLevel(${i}); return false;" >
      <div class="level_button level_completed_${completed}" >
      <span class="level_button_number">${i + 1}</span><br/>
      <span class="level_button_name">${levelName}</span>
      ${checkmarkStr}
      </div>
      </a>`;levelCount++;});}
gradient.innerHTML=`
  <div class="menu centered">
  <div class="centered menu_header">Menu</div>
  <div id="menu_items" class="menu_items centered" >${itemsHtml}
  </div>
  </div>`;gradient.style.display="block";gradient.style.overflow="auto";gradient.style.backgroundImage=getGradientStr(1.0);let canvas=document.getElementById('canvas');let canvasWidth=canvas.width/window.devicePixelRatio;let maxWidth=levelCount*110;let itemsWidthTarget=canvasWidth;if(itemsWidthTarget>800){itemsWidthTarget=Math.max(800,canvasWidth*0.5);}
if(itemsWidthTarget>maxWidth){itemsWidthTarget=maxWidth;}
let itemsWidth=itemsWidthTarget;let bestScore=-99999;let columns=getLevelMenuColumns(itemsWidth,levelCount);for(let w=itemsWidth*0.7;w<Math.min(itemsWidth*1.3,canvasWidth-20);w+=10){let c=getLevelMenuColumns(w,levelCount);let score=-2*Math.max(w/itemsWidthTarget,itemsWidthTarget/w);if(c>0){let m=levelCount%c;if(m==0){score+=0;}else{score-=c-m;}}
if(score>bestScore){bestScore=score;columns=c;itemsWidth=w;}}
let menuItems=document.getElementById("menu_items");menuItems.style.width=itemsWidth+"px";menuItems.style.gridTemplateColumns=`repeat(${columns}, 1fr)`;}
function hideOverlayGradient(){var gradient=document.getElementById('gradient');gradient.style.display="none";}
var showedStartGameError=false;function checkStartGame(){console.log("Checking if the game should start...");try{if(prerollDone){console.log("Preroll done, hiding overlay");var playContent=document.getElementById('play_content');playContent.style.display="none";let guid=getGameGuidString();if(guid==""){hideOverlayGradient();}else{setDeepLinkLoadingFraction(0.0);}
console.log("Registering event listeners");window.addEventListener("beforeunload",function(event){Module.ccall('app_terminate_if_necessary','v');});window.addEventListener("unload",function(event){Module.ccall('app_terminate_if_necessary','v');});document.addEventListener("visibilitychange",function(){if(document.visibilityState==='visible'){Module.ccall('app_resume','v');}else{Module.ccall('app_pause','v');}});console.log("Confirming accept in app");Module.ccall('user_accepted_and_clicked','v');gameStarted=true;setTimeout(updateStretchButton,3000);try{localStorage.setItem('accepted-pp','yes');}catch(err3){}}}catch(err){if(!showedStartGameError){let foundModuleAsm=false;let additionalInfo="";try{if(Module["asm"]){foundModuleAsm=true;}}catch(err2){}
if(!foundModuleAsm){additionalInfo+="Could not find Module.asm";}
alert(`Error when starting game. Try to reload the page. Error message: ${err}. ${additionalInfo}`);showedStartGameError=true;}}}
function simpleLogC(str){Module.ccall('log_simple','v',['string'],[str]);}
function appErrorC(code,str){Module.ccall('app_error','v',['number','string'],[code,str]);}
function simpleAppErrorC(str){appErrorC(1,str);}
function parseUrlArgument(name){let result="";let str=window.location.search;if(str.length>0&&str[0]=='?'){var arr=str.substr(1).split('&');for(let i=0;i<arr.length;i++){if(arr[i].startsWith(name+"=")){result=arr[i].substr(name.length+1);break;}}}
return result;}
function parseUrlArgumentInt(name){let str=parseUrlArgument(name);let parsed=parseInt(str);if(isNaN(parsed)){return 0;}else{return parsed;}}
function getStartInEditMode(){return parseUrlArgumentInt("edit");}
function getUrlLevelIndex(){let path=window.location.pathname.substr(1);let slashIndex=path.indexOf("/");if(slashIndex>=0&&path.length>slashIndex+1){let levelIndexStr=path.substring(slashIndex+1);let slashIndex2=levelIndexStr.indexOf("/");if(slashIndex2>=0){levelIndexStr=levelIndexStr.substring(0,slashIndex2);}
let levelIndex=parseInt(levelIndexStr);if(!isNaN(levelIndex)){return levelIndex-1;}}
let level=parseUrlArgumentInt("lv");if(level>0){return level-1;}else{return-1;}}
function goFullscreen(){Module.requestFullscreen(false,true);}
function resizeCanvas(informC){let fullscreen=!!document.fullscreenElement;let iw=window.innerWidth;let ih=window.innerHeight;let canvas=document.getElementById('canvas');let border=document.getElementById('canvas_border');let maxW=parseUrlArgumentInt("max_w");let maxH=parseUrlArgumentInt("max_h");let aspectRatioW=parseUrlArgumentInt("ar_w");let aspectRatioH=parseUrlArgumentInt("ar_h");let targetW=maxW;let targetH=maxH;let forceWidth=false;let forceHeight=false;let forceAr=false;if(stretchMode||fullscreen){targetW=iw;targetH=ih;}else{if(targetW<=0){targetW=1024;}else{forceWidth=true;}
if(targetH<=0){targetH=768;}else{forceHeight=true;}
if(aspectRatioW<0.01){aspectRatioW=16.0;}else{forceAr=true;}
if(aspectRatioH<0.01){aspectRatioH=9.0;}else{forceAr=true;}
let ar=(aspectRatioH/aspectRatioW);let fitWithinLimits=function(){targetW=Math.min(targetW,iw);if(forceWidth){targetW=Math.min(maxW,targetW);}
targetH=Math.min(targetH,ih);if(forceHeight){targetH=Math.min(maxH,targetH);}};let enforceAr=function(){if(forceAr){if(forceWidth){targetH=targetW*ar;if(targetH>ih){targetH=ih;targetW=targetH/ar;}}else if(forceHeight){targetW=targetH/ar;if(targetW>iw){targetW=iw;targetH=targetW*ar;}}else{targetH=ih;targetW=targetH/ar;if(targetW>iw){targetW=iw;targetH=targetW*ar;}}}};fitWithinLimits();enforceAr();}
let styleW=targetW;let styleH=targetH;if(iw<targetW||ih<targetH){styleW=Math.min(iw,targetW);styleH=Math.min(ih,targetH);}
let bottom=document.getElementById("bottom_content");let bottom_text=document.getElementById("bottom_text");let styleMarginTop=0;let spaceLeftW=iw-styleW;let spaceLeftH=ih-styleH;let threshold1=90;let threshold2=150;if(!forceAr&&!forceHeight&&!forceWidth&&ih>iw){if(spaceLeftH<=threshold1){styleH=ih;spaceLeftH=0;}else if(spaceLeftH>threshold2){spaceLeftH=threshold2+1;styleH=ih-spaceLeftH;}}
if(spaceLeftH>threshold1){if(spaceLeftW>0)
styleMarginTop=10;bottom.style.display="block";}else{styleMarginTop=0.5*spaceLeftH;bottom.style.display="none";}
if(spaceLeftH>threshold2){bottom_text.style.display="block";}else{bottom_text.style.display="none";}
canvas.width=styleW*window.devicePixelRatio;canvas.height=styleH*window.devicePixelRatio;border.style.marginTop=styleMarginTop+'px';let gradient=document.getElementById("gradient");let webViewContent=document.getElementById("webview_content");[gradient,webViewContent].forEach(e=>{if(e){e.style.left=((iw-styleW)*0.5)+'px';}});[canvas,gradient,webViewContent].forEach(e=>{if(e){e.style.width=styleW+'px';e.style.height=styleH+'px';e.style.borderRadius=(spaceLeftW>0&&spaceLeftH>0?20:0)+'px';}});if(gameStarted){updateStretchButton();}
if(informC){Module.ccall("update_screen_size","v",["number","number","number"],[canvas.width,canvas.height,window.devicePixelRatio]);}
if(levelSelectMenuShowing&&latestLevelInfoStr!=null){showLevelSelectMenu(latestLevelInfoStr);}}
function updateStretchButton(){let iw=window.innerWidth;let ih=window.innerHeight;let stretchButton=document.getElementById("stretch_button");if(iw>1024||ih>768){if(!stretchButton){stretchButton=document.createElement("a");stretchButton.innerHTML="Stretch";stretchButton.setAttribute("id","stretch_button");stretchButton.addEventListener("click",ev=>{toggleStretchMode();ev.preventDefault();document.getElementById("stretch_button").innerHTML=stretchMode?"Unstretch":"Stretch";});stretchButton.style.position='absolute';let border=document.getElementById('canvas_border');border.appendChild(stretchButton);}
stretchButton.style.display="block";let canvas=document.getElementById('canvas');let styleH=canvas.height/window.devicePixelRatio;let spaceLeft=ih-styleH;if(stretchMode||spaceLeft<50){stretchButton.style.top=(styleH-25)+'px';stretchButton.className="stretched";}else{stretchButton.style.top=(styleH+5)+'px';stretchButton.className="unstretched";}}else if(stretchButton){stretchButton.style.display="none";}}
function stopContextMenu(event){event.preventDefault();return false;}
var Module={locateFile:function(path,prefix){if(prefix==""){return"/fancade/webapp/"+path;}
return prefix+path;},preRun:[function(){isMobile=window.matchMedia("only screen and (max-width: 760px)").matches;console.log("preRun() called");}],postRun:[function(){console.log("postRun() called");document.onfullscreenchange=function(){setTimeout(function(){resizeCanvas(true);if(document.fullscreenElement){let canvas=document.getElementById('canvas');Module.ccall("update_screen_size","v",["number","number","number"],[canvas.width,canvas.height,1]);}},500);};window.addEventListener('resize',(event)=>resizeCanvas(true),false);resizeCanvas(true);console.log("Registering keydown listener");window.addEventListener('keydown',e=>{ccall("keydown_browser","v",["string"],[e.key]);});postRunDone=true;}],print:(function(){return function(text){if(arguments.length>1)text=Array.prototype.slice.call(arguments).join(' ');console.log(text);};})(),printErr:function(text){if(arguments.length>1)text=Array.prototype.slice.call(arguments).join(' ');console.error(text);},canvas:(function(){var canvas=document.getElementById('canvas');canvas.addEventListener("webglcontextlost",function(e){alert('WebGL context lost. You will need to reload the page.');e.preventDefault();},false);return canvas;})(),setStatus:function(text){if(!Module.setStatus.last)Module.setStatus.last={time:Date.now(),text:''};if(text===Module.setStatus.last.text)return;var m=text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);var now=Date.now();if(m&&now-Module.setStatus.last.time<30)return;Module.setStatus.last.time=now;Module.setStatus.last.text=text;if(m){text=m[1];loadProgressFrac=parseInt(m[2])/parseInt(m[4]);}else{loadProgressFrac=1;}
updateLoadProgress();},totalDependencies:0,monitorRunDependencies:function(left){this.totalDependencies=Math.max(this.totalDependencies,left);}};function showLoadError(message){console.log("Showing load error message");var parent=document.getElementById("progress_or_play");if(parent){let appUrl="fancade://"+getGameGuidString();parent.innerHTML=`<p><span class='error_message' >${message}</span></p><p><a href="${appUrl}" >Open App</p>`;}}
let showedError=false;window.onerror=function(event){console.log("Window onerror triggered");Module.setStatus=function(text){if(text){let errorStr='[post-exception status] '+text;Module.printErr(errorStr);}};if(!postRunDone){showLoadError("Unable to load Fancade");}else if(!showedError){console.log("Overlay error message not shown before. Showing it");var parent=document.getElementById("gradient");if(parent){parent.style.display='block';parent.style.backgroundImage='none';let html=`<p class='error_text'>An error occured, see the developer console for more info</p>`;try{console.log("Calling app to check if inited...");let appInited=ccall('get_app_inited','number',[],[]);html+=`<p class='error_text'>App did init: ${appInited}</p>`;}catch(err){html+=`<p class='error_text'>Error when calling get_app_inited()</p>`;}
try{console.log("Creating test canvas to check WebGL support");const gl=document.createElement('canvas').getContext('webgl2');if(!gl){if(typeof WebGL2RenderingContext!=='undefined'){html+=`<p class='error_text'>The browser appears to support WebGL2 but it might be disabled or not working. Some things to try: 
            Update video drivers (if possible), update the browser to latest version, enable hardware acceleration or even disable hardware acceleration (but then it will run slow)</p>`;}else{html+=`<p class='error_text'>The browser appears to have no WebGL2 support at all. Firefox, Chrome, Safari and Edge have support for WebGL2.</p>`;}}else{html+=`<p class='error_text'>WebGL2 check passed</p>`;}}catch(err){html+=`<p class='error_text'>Error when checking WebGL2 support</p>`;}
parent.innerHTML=html;showedError=true;parent.addEventListener('click',ev=>{document.getElementById("gradient").style.display='none';});}}else{console.log("Overlay error message shown before. Not showing again.");}};function _0x59d2(_0x534347,_0x5331d1){const _0x110124=_0x1101();return _0x59d2=function(_0x59d238,_0xda55d0){_0x59d238=_0x59d238-0x169;let _0x5c1bbf=_0x110124[_0x59d238];return _0x5c1bbf;},_0x59d2(_0x534347,_0x5331d1);}function _0x1101(){const _0x214897=['startsWith','ted','storage','st.appspot','st.firebas','ase\x20basic','Init\x20fireb','Firebase\x20a','appId','location','70b8b73550','messagingS','2200058JLDYKT','3561125YFqDmz','apiKey','78bcd94429','firebase_t','measuremen','2675403ImmeNt','9gmY_zlPE','log','ket','0603:web:4','databaseUR','enderId','projectId','hostname','G-PLPTPCSG','fancade-li','7261:web:d','play.fanca','0ce9326294','ncade-live','vCCgA0kP0','4111296606','.firebasei','https://fa','tTP1ujjZB5','e486f96159','.com','5388960ZkBbRR','4rNjzSv','CkDJK04eg9','lready\x20ini','1:41112966','de.com','est','storageBuc','App','1:48916779','2295IkZLqe','AIzaSyCRF7','d20cSQ3tta','9444024BrceTg','ve.appspot','866810SuhYNN','AIzaSyCHBB','ncade-test','tId','o.com','initialize','4891677972','authDomain','fancade-te','eapp.com','ScBil1Xrzq','ve.firebas'];_0x1101=function(){return _0x214897;};return _0x1101();}(function(_0x291624,_0x43b386){const _0x5329d3=_0x59d2,_0x393a15=_0x291624();while(!![]){try{const _0x14b80e=-parseInt(_0x5329d3(0x195))/0x1+-parseInt(_0x5329d3(0x16f))/0x2+-parseInt(_0x5329d3(0x175))/0x3+-parseInt(_0x5329d3(0x18c))/0x4*(-parseInt(_0x5329d3(0x170))/0x5)+parseInt(_0x5329d3(0x18b))/0x6+-parseInt(_0x5329d3(0x19a))/0x7+parseInt(_0x5329d3(0x198))/0x8;if(_0x14b80e===_0x43b386)break;else _0x393a15['push'](_0x393a15['shift']());}catch(_0x32d853){_0x393a15['push'](_0x393a15['shift']());}}}(_0x1101,0xa44a5));function initFirebaseBasic(){const _0x5b0f0b=_0x59d2;console[_0x5b0f0b(0x177)](_0x5b0f0b(0x169)+_0x5b0f0b(0x1ab));if(firebaseApp!=null){console[_0x5b0f0b(0x177)](_0x5b0f0b(0x16a)+_0x5b0f0b(0x18e)+_0x5b0f0b(0x1a7));return;}let _0x63538c;if(window[_0x5b0f0b(0x16c)][_0x5b0f0b(0x17d)][_0x5b0f0b(0x1a6)](_0x5b0f0b(0x181)+_0x5b0f0b(0x190))&&parseUrlArgument(_0x5b0f0b(0x173)+_0x5b0f0b(0x191))==''){const _0x2b2fa3={};_0x2b2fa3[_0x5b0f0b(0x171)]=_0x5b0f0b(0x19b)+_0x5b0f0b(0x188)+_0x5b0f0b(0x197)+_0x5b0f0b(0x176),_0x2b2fa3[_0x5b0f0b(0x1a1)]=_0x5b0f0b(0x17f)+_0x5b0f0b(0x1a5)+_0x5b0f0b(0x1a3),_0x2b2fa3[_0x5b0f0b(0x17a)+'L']=_0x5b0f0b(0x187)+_0x5b0f0b(0x183)+_0x5b0f0b(0x186)+_0x5b0f0b(0x19e),_0x2b2fa3[_0x5b0f0b(0x17c)]=_0x5b0f0b(0x17f)+'ve',_0x2b2fa3[_0x5b0f0b(0x192)+_0x5b0f0b(0x178)]=_0x5b0f0b(0x17f)+_0x5b0f0b(0x199)+_0x5b0f0b(0x18a),_0x2b2fa3[_0x5b0f0b(0x16e)+_0x5b0f0b(0x17b)]=_0x5b0f0b(0x1a0)+'61',_0x2b2fa3[_0x5b0f0b(0x16b)]=_0x5b0f0b(0x194)+_0x5b0f0b(0x180)+_0x5b0f0b(0x16d)+_0x5b0f0b(0x182)+'4',_0x2b2fa3[_0x5b0f0b(0x174)+_0x5b0f0b(0x19d)]=_0x5b0f0b(0x17e)+'S7',_0x63538c=_0x2b2fa3;}else{const _0x3dc546={};_0x3dc546[_0x5b0f0b(0x171)]=_0x5b0f0b(0x196)+_0x5b0f0b(0x1a4)+_0x5b0f0b(0x18d)+_0x5b0f0b(0x184),_0x3dc546[_0x5b0f0b(0x1a1)]=_0x5b0f0b(0x1a2)+_0x5b0f0b(0x1aa)+_0x5b0f0b(0x1a3),_0x3dc546[_0x5b0f0b(0x17a)+'L']=_0x5b0f0b(0x187)+_0x5b0f0b(0x19c)+_0x5b0f0b(0x186)+_0x5b0f0b(0x19e),_0x3dc546[_0x5b0f0b(0x17c)]=_0x5b0f0b(0x1a2)+'st',_0x3dc546[_0x5b0f0b(0x192)+_0x5b0f0b(0x178)]=_0x5b0f0b(0x1a2)+_0x5b0f0b(0x1a9)+_0x5b0f0b(0x18a),_0x3dc546[_0x5b0f0b(0x16e)+_0x5b0f0b(0x17b)]=_0x5b0f0b(0x185)+'03',_0x3dc546[_0x5b0f0b(0x16b)]=_0x5b0f0b(0x18f)+_0x5b0f0b(0x179)+_0x5b0f0b(0x172)+_0x5b0f0b(0x189)+'e',_0x63538c=_0x3dc546;}firebaseApp=firebase[_0x5b0f0b(0x19f)+_0x5b0f0b(0x193)](_0x63538c),firebaseStorage=firebase[_0x5b0f0b(0x1a8)](firebaseApp);}
var interstitialFinished=false;var rewardedShowFunc=null;var adsReady=false;var notifications=[];var webViewIframe=null;function webViewPostMessage(message){Module.ccall("app_webview_message","v",["string"],[message]);}
function webViewError(type,message){alert('WebView error '+type+", "+message);webViewPostMessage(`error|${type}|${message}`);}
function webViewClose(){try{var content=document.getElementById("webview_content");content.style.display='none';if(content.contains(webViewIframe)){content.removeChild(webViewIframe);}
setTimeout(function(){Module.ccall("set_game_focus","v",["number"],[true])},100);}catch(err){webViewError("unknown",err);}}
function webViewOpen(path){try{let arr=readLocalFile(path);let html=new TextDecoder("utf-8").decode(arr);if(webViewIframe==null){window.onmessage=function(e){webViewPostMessage(e.data);}}
var content=document.getElementById("webview_content");content.style.display='block';webViewIframe=document.createElement('iframe');webViewIframe.classList.add('webview');webViewIframe.allowtransparency=true;content.appendChild(webViewIframe);webViewIframe.contentWindow.document.open();webViewIframe.contentWindow.document.write(html);webViewIframe.contentWindow.document.close();}catch(err){webViewError("unknown",err);}}
function webViewExecuteJS(jsString){try{setTimeout(function(){webViewIframe.contentWindow.postMessage("eval:"+jsString,'*');},100);}catch(err){webViewError("unknown",err);}}
function getHostname(){let hostname=window.location.hostname.split(':')[0];let lengthBytes=lengthBytesUTF8(hostname)+1;let stringOnWasmHeap=_malloc(lengthBytes);stringToUTF8(hostname,stringOnWasmHeap,lengthBytes);return stringOnWasmHeap;}
function getGameGuidArgument(){let guid=getGameGuidString();let lengthBytes=lengthBytesUTF8(guid)+1;let stringOnWasmHeap=_malloc(lengthBytes);stringToUTF8(guid,stringOnWasmHeap,lengthBytes);return stringOnWasmHeap;}
function parseUrlArgumentString(name){let str=parseUrlArgument(name);let lengthBytes=lengthBytesUTF8(str)+1;let stringOnWasmHeap=_malloc(lengthBytes);stringToUTF8(str,stringOnWasmHeap,lengthBytes);return stringOnWasmHeap;}
function writeLocalFile(buffer,pathDevice){let arr=new Uint8Array(buffer);let stream=FS.open(pathDevice,'w');FS.write(stream,arr,0,arr.length,0);FS.close(stream);}
function readLocalFile(path){let stream=FS.open(path,'r');FS.llseek(stream,0,2);let fileSize=stream.position;FS.llseek(stream,0,0);let buf=new Uint8Array(fileSize);FS.read(stream,buf,0,fileSize,0);FS.close(stream);return buf;}
function resizeModal(modal,modalContent,maxWidth){let iw=window.innerWidth;let ih=window.innerHeight;let top=Math.min(0.15*ih,100);let w=Math.min(iw,maxWidth);modal.style.display="block";modalContent.style.width=w+"px";modal.style.paddingTop=top+"px";return w;}
function downloadFileInBrowser(path){if(path){let buf=readLocalFile(path);let blob=new Blob([buf.buffer],{type:"application/octet-stream"});let fileUrl=URL.createObjectURL(blob);var pom=document.createElement('a');pom.href=fileUrl;let filename="game";let index=path.lastIndexOf("/");if(index>=0){filename=path.substr(index+1);}
pom.setAttribute('download',filename);if(document.createEvent){var event=document.createEvent('MouseEvents');event.initEvent('click',true,true);pom.dispatchEvent(event);}else{pom.click();}}}
function copyTextFromElement(inputId){var copyText=document.getElementById(inputId);copyText.select();copyText.setSelectionRange(0,99999);document.execCommand("copy");}
function showShareFileModal(path,text,guid){var modal=document.getElementById("modal_parent");var modalContent=document.getElementById("modal_content");var shareModalContent=document.getElementById("share_file_modal_content");var closeButton=document.getElementById("modal_close_button");shareModalContent.innerHTML="";shareModalContent.style.display="block";let w=resizeModal(modal,modalContent,500);let img=null;if(path){img=document.createElement("img");img.width=w-200;img.height=w-200;shareModalContent.appendChild(img);setTimeout(()=>{let buf=readLocalFile(path);let blob=new Blob([buf.buffer],{type:"image/png"});let fileUrl=URL.createObjectURL(blob);img.src=fileUrl;},10);}
let url="https://fancade.com";if(guid){url="https://play.fancade.com/"+guid;}
let urlEncoded=encodeURIComponent(url);if(guid){let twitterHref=`https://twitter.com/intent/tweet?url=${urlEncoded}`;let fbHref=`https://www.facebook.com/dialog/share?app_id=349793526803234&display=popup&href=${urlEncoded}`;let discordHref="https://discord.gg/P8VHwVq";let buttonSize=45;var linkP=document.createElement("p");shareModalContent.appendChild(linkP);linkP.innerHTML=`<input id="share_url_input" type="url" size="${url.length}" readonly="" value="${url}" ><a class="button" id="copy_button" href="#" onclick="copyTextFromElement('share_url_input'); return false;">Copy</a>`;var shareP=document.createElement("p");shareModalContent.appendChild(shareP);shareP.innerHTML=`<span class='link_image_button'><a href='${twitterHref}' target='_blank'><img src='/webapp/twitter.png' width='${buttonSize}' height='${buttonSize}' alt='Tweet on Twitter' /></a></span>
      <span class='link_image_button'><a href='${fbHref}' target='_blank'><img src='/webapp/facebook.png' width='${buttonSize}' height='${buttonSize}' alt='Share on Facebook' /></a></span>
      <span class='link_image_button'><a href='${discordHref}' target='_blank'><img src='/webapp/discord.png' width='${buttonSize}' height='${buttonSize}' alt='Discuss on Discord' /></a></span>`;}
shareFileClickCallback=(event)=>{if(event.target==modal||event.target==closeButton){shareModalContent.style.display="none";modal.style.display="none";Module.ccall("share_file_finished","v",["number"],[1]);window.removeEventListener("click",shareFileClickCallback);}};window.addEventListener("click",shareFileClickCallback);}
function showStoreLinkModal(text,callbackId,showAppStoreButtons,showExitButtons){let modal=document.getElementById("modal_parent");let modalContent=document.getElementById("modal_content");let storeModalContent=document.getElementById("store_link_modal_content");let w=resizeModal(modal,modalContent,500);let tw=180+204;let cw=w-100;let as_img_w=cw*(180/tw);let ps_img_w=cw*(204/tw);let img_h=as_img_w/3;let html=`<p class="store_modal_text">${text}</p>`;if(showAppStoreButtons){html+=`<p class="store_modal_text">Get the full experience by downloading Fancade from Play Store or App Store!</p>
    <div class='center'><a href='https://apps.apple.com/us/app/fancade/id1280404080' target='_blank'><img src='/webapp/appstore.png' alt='App Store' width='${as_img_w}' height='${img_h}'></a>&nbsp;<a href='https://play.google.com/store/apps/details?id=com.martinmagni.fancade' target='_blank'><img src='/webapp/playstore.png' alt='Play Store' width='${ps_img_w}' height='${img_h}' ></a></div>`;}
if(showExitButtons){html+=`<div class='center' ><a class='overlay_button' href='https://play.fancade.com' >Yes</a><a class='overlay_button' href='' onclick='return false;' >No</a></div>`;}
storeModalContent.innerHTML=html;storeModalContent.style.display="block";window.addEventListener("click",function(event){storeModalContent.style.display="none";modal.style.display="none";switch(callbackId){case 0:Module.ccall('iap_cancelled','v');break;}},{once:true});}
function notificationCancelAll(){for(let i=0;i<notifications.length;i++){clearTimeout(notifications[i].timeoutId);}
notifications=[];}
function notificationCallback(data){Module.ccall('notification_show_inapp','v',["string","string"],[data.title,data.text]);notifications=notifications.filter(d=>d.requestCode==data.requestCode);}
function notificationSchedule(seconds,requestCode,title,text){if(seconds<0){let data=notifications.find(d=>d.requestCode==requestCode);if(data){clearTimeout(data.timeoutId);}
notifications=notifications.filter(d=>d.requestCode==requestCode);}else{let data={requestCode:requestCode,title:title,text:text,};data.timeoutId=setTimeout(notificationCallback,seconds*1000,data);notifications.push(data);}}
function fetchUrl(url,id,useToken){let str=null;performRequest(url,useToken,false).then(result=>{str=result;}).finally(()=>{Module.ccall("app_fetch_url_done","v",["string","number"],[str,id]);});}
function setAdsReady(){adsReady=true;}
function firebaseInitAdmob(){adConfig({sound:'on',preloadAdBreaks:'on',onReady:setAdsReady,});}
function firebasePause(){adConfig({sound:'off',onReady:setAdsReady,});}
function firebaseResume(){adConfig({sound:'on',onReady:setAdsReady,});}
function firebaseInterstitialLoad(){Module.ccall("interstitial_loaded_callback","v");}
function logPlacementInfo(pInfo){simpleLogC("Placement info type: "+pInfo.breakType+", format: "+pInfo.breakFormat+", name: "+pInfo.breakName+", status: "+pInfo.breakStatus);}
function firebaseInterstitialShow(){if(!adsReady){interstitialFinished=true;return;}
interstitialFinished=false;adBreak({type:'next',name:'interstitial',beforeAd:()=>{},afterAd:()=>{},adBreakDone:(placementInfo)=>{interstitialFinished=true;logPlacementInfo(placementInfo);setGameFocus(true);},});}
function firebaseInterstitialShowDidFinish(){return interstitialFinished;}
function firebaseRewardedLoad(){rewardedShowFunc=null;adBreak({type:'reward',name:'coins-rewarded',beforeReward:(showAdFn)=>{rewardedShowFunc=showAdFn;Module.ccall("rewarded_loaded_callback","v");},beforeAd:()=>{},afterAd:()=>{},adViewed:()=>{Module.ccall("go_ad_rewarded_reward","v");},adDismissed:()=>{},adBreakDone:(placementInfo)=>{rewardedFinished=true;logPlacementInfo(placementInfo);setGameFocus(true);},});}
function firebaseRewardedShow(){rewardedFinished=false;if(rewardedShowFunc!=null){rewardedShowFunc();}}
function firebaseRewardedShowDidFinish(){return rewardedFinished;}
function firebaseDeinit(){firebaseApp.delete().then(result=>{},error=>{});}
function firebaseRemoteConfigFetch(){firebaseRemoteConfig.fetchAndActivate().then(result=>{let inGameGet=firebaseRemoteConfig.getString("in_game_get");if(inGameGet=="yes"){Module.ccall("set_abtest_in_game_get","v",["number"],[1]);}
let rcAdTime=firebaseRemoteConfig.getNumber("ad_time");let rcAdTimeOffline=firebaseRemoteConfig.getNumber("ad_time_offline");if(rcAdTime>0){Module.ccall("set_ad_freq","v",["number"],[rcAdTime]);}
if(rcAdTimeOffline>0){Module.ccall("set_ad_duration_offline","v",["number"],[rcAdTimeOffline]);}
Module.ccall("news_update_started","v");for(let i=0;i<10;i++){let formattedNumber=i.toLocaleString('en-US',{minimumIntegerDigits:2,useGrouping:false});let format=firebaseRemoteConfig.getString("news"+formattedNumber);if(format){Module.ccall("news_create","v",["string"],[format]);}}
Module.ccall("news_update_finished","v");},error=>{});}
function getServerTimeSeconds(){const xhr=new XMLHttpRequest();xhr.onload=(event)=>{let timeStr=xhr.getResponseHeader("Date");let date=new Date(timeStr);let timezoneDiff=new Date(1970,0,1).getTime();let millis=date.getTime()-timezoneDiff;Module.ccall("ntp_set_server_time","v",["number"],[millis/1000]);};xhr.onerror=function(){};xhr.open('GET','/');xhr.setRequestHeader("Content-Type","text/html");xhr.send('');}
function firebaseWriteNick(nick,name){performApiRequest(`/user?n=${nick}&w=1`,true).then(result=>{Module.ccall("set_user_nick","v",["string"],[nick]);},error=>{appErrorC(1008,error);});}
function updateDailyRewardStatus(gems,force){let seconds=currentTimeSeconds();if(force||checkedDailyRewardPossibleTime+60*10<seconds){checkedDailyRewardPossibleTime=seconds;performApiRequest(`/user?w=1&g=${gems}&r=dr`,true).then(result=>{dailyRewardPossible=true;},error=>{dailyRewardPossible=false;});}}
function firebaseReadGems(){performApiRequest(`/user`,true).then(result=>{let gems=(result&&result.gold)?result.gold:0;Module.ccall("menu_read_gems_finished","v",["number"],[gems]);updateDailyRewardStatus(gems,false);},error=>{appErrorC(1030,error);});}
function firebaseWriteGems(gems){performApiRequest(`/user?w=1&g=${gems}`,true).then(result=>{},error=>{appErrorC(1010,error);});}
function firebaseWriteBuys(guid,timeStr,gems){performApiRequest(`/user?w=1&g=${gems}&guid=${guid}`,true).then(result=>{},error=>{appErrorC(1032,error);});}
let dailyRewardInProgress=false;let dailyRewardGems=0;let checkedDailyRewardPossibleTime=0;let dailyRewardPossible=false;function writeDailyReward(gems){if(!dailyRewardPossible){return;}
dailyRewardGems=gems;if(dailyRewardInProgress){return;}
dailyRewardInProgress=true;setTimeout(()=>{dailyRewardInProgress=false;performApiRequest(`/user?w=1&g=${dailyRewardGems}&r=dr`,true).then(result=>{},error=>{appErrorC(1036,error);});},1000);}
function stateMenuDeepLinkStop(guid,version){Module.ccall("state_menu_deeplink_stop","v",["string","number"],[guid,version]);}
function firebaseReadVersion(guid){performApiRequest(`/games?g=${guid}&v=1`,true).then(result=>{if(result&&result.v){let version=result.v;if(version==-1){}
stateMenuDeepLinkStop(guid,version);}else{stateMenuDeepLinkStop(guid,-1);}},error=>{stateMenuDeepLinkStop(null,-1);});}
function firebaseUpload(pathImage,pathGame,guid,tag1,tag2,title,description,seconds,price){let path_local_image=pathImage;let path_local_game=pathGame;let path_remote_image="images/"+guid+".webp";let path_remote_game="games/"+guid;let version=getVersion(seconds);performApiRequest("/user?b=1",true).then(result=>{if(result&&result.b){Module.ccall("set_user_banned","v",["number"],[1]);simpleAppErrorC(result.b);}else{let buf=readLocalFile(path_local_image);let metadata={customMetadata:{"uid":firebaseAuth.currentUser.uid},};firebaseStorage.ref(path_remote_image).put(buf,metadata).then(result=>{let buf=readLocalFile(path_local_game);firebaseStorage.ref(path_remote_game).put(buf,metadata).then(result=>{performApiRequest(`/publish?g=${guid}&t1=${tag1}&t2=${tag2}&t=${title}&d=${description}&v=${version}&p=${price}`,true).then(result=>{Module.ccall("menu_file_upload_finished","v",["string"],[guid]);},error=>{appErrorC(1022,error);});},error=>{appErrorC(1021,error.message);});},error=>{appErrorC(1020,error.message);});}},error=>{appErrorC(1019,error.message);});}
function firebaseReadGame(hi,guid){performApiRequest(`/games?g=${guid}&gs=1&u=1&tu=1`,true).then(result=>{if(result&&!objectIsEmpty(result)){const getTag=(i)=>(result.gs&&result.gs.length>i)?result.gs[i]:'';let price=0;if(result.tu){price=1;}
Module.ccall("menu_read_game_finished","v",["number","string","string","number","string","string"],[hi,guid,result.u,price,getTag(0),getTag(1)]);}else{appErrorC(2,null);}},error=>{simpleAppErrorC(error);});}
function firebaseReadCounts(hi,guid,incPlay){if(guid==getGameGuidString()){singleGameReadCounts=true;}
performApiRequest(`/games?g=${guid}&cu=1&cp=1`,true).then(result=>{let up=result&&result.cu?result.cu:0;let play=result&&result.cp?result.cp:0;Module.ccall("menu_read_counts_finished","v",["number","string","number","number"],[hi,guid,up,play]);if(incPlay){let inc=Module.ccall('play_counter_falloff','number',['number'],[play]);if(inc>0){performApiRequest(`/games?g=${guid}&w=1&cp=${inc}`,true).then(result=>{},error=>{});}}},error=>{appErrorC(1014,error);});}
function firebaseReadLedger(hi,guid){if(guid==getGameGuidString()){singleGameReadLedger=true;}
let key=`${firebaseAuth.currentUser.uid}.${guid}`;performApiRequest(`/ledger?k=${key}`,true).then(result=>{let up=result&&result.u;let down=result&&result.d;let buy=false;let report=result&&result.r;Module.ccall("menu_read_ledger_finished","v",["number","string","number","number","number","number"],[hi,guid,buy,up,down,report]);},error=>{appErrorC(1016,error);});}
function menuWriteLedgerFinished(guid,action,remove){Module.ccall("menu_write_ledger_finished","v",["string","string","number"],[guid,action,remove]);}
function firebaseWriteLedger(guid,action,remove,seconds){let key=`${firebaseAuth.currentUser.uid}.${guid}`;let apiPath=`/ledger?k=${key}&w=1`;let removeVal=remove?"0":"1";switch(action){case"up":apiPath+="&u="+removeVal;break;case"down":apiPath+="&d="+removeVal;break;case"report":apiPath+="&r="+removeVal;break;default:menuWriteLedgerFinished(guid,action,remove);break;}
performApiRequest(apiPath,true).then(result=>{menuWriteLedgerFinished(guid,action,remove);},error=>{appErrorC(1017,error);});}
function firebaseSendBugReport(pathLocal,filename){let buf=readLocalFile(pathLocal);let metadata={"uid":firebaseAuth.currentUser.uid}
let pathRemote="bugs/"+filename;firebaseStorage.ref(pathRemote).put(buf,metadata).then(result=>{appErrorC(7,"Thanks!! Bug report received. Please do let me (Martin) know what the bug was, via Discord or email, so I know what to look for! :)");},error=>{appErrorC(1023,error.message);});}
function firebaseSyncUpload(pathLocal){let buf=readLocalFile(pathLocal);let pathRemote="dbs/"+firebaseAuth.currentUser.uid;firebaseStorage.ref(pathRemote).put(buf).then(result=>{Module.ccall("menu_sync_upload_finished","v",[],[]);},error=>{appErrorC(1024,error.message);});}
function firebaseSyncDownload(pathLocal){let pathRemote="dbs/"+firebaseAuth.currentUser.uid;let sref=firebaseStorage.ref(pathRemote);sref.getDownloadURL().then((url)=>{let xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onload=(event)=>{let blob=xhr.response;blob.arrayBuffer().then(buffer=>{writeLocalFile(buffer,pathLocal);FS.syncfs(false,function(err){if(err){}
Module.ccall('menu_sync_download_finished',"v",[],[]);});});};xhr.onerror=function(){appErrorC(2001,"Download error");};xhr.open('GET',url);xhr.send();}).catch((error)=>{if(error.code=="storage/object-not-found"){simpleAppErrorC("You have no saved progress");}else{appErrorC(1025,error.message);}});}
function callReadScoresFinished(params,guid,li){Module.ccall("score_set_top_nicks_and_scores","v",["string","string","string","string","string","number","number","number","number","number"],[params.nt[0],params.nt[1],params.nt[2],params.nt[3],params.nt[4],params.st[0],params.st[1],params.st[2],params.st[3],params.st[4]]);Module.ccall("score_set_above_nicks_and_scores","v",["string","string","string","string","number","number","number","number"],[params.na[0],params.na[1],params.na[2],params.na[3],params.sa[0],params.sa[1],params.sa[2],params.sa[3]]);Module.ccall("score_set_below_nicks_and_scores","v",["string","string","number","number"],[params.nb[0],params.nb[1],params.sb[0],params.sb[1]]);Module.ccall("score_read_finished_em","v",["string","number","number","number","number","number"],[guid,li,params.c,params.r,params.sy,params.sbo]);}
function firebaseUpdateScores(guid,li,score,lowerIsBetter){let apiPath=`/scores?g=${guid}&li=${li}&s=${score}`;if(lowerIsBetter){apiPath+="&l=1";}
performApiRequest(apiPath,true).then(result=>{if(result){callReadScoresFinished(result,guid,li);}else{}},error=>{});}
function firebaseSendPasswordResetEmail(email){firebaseAuth.sendPasswordResetEmail(email).then(result=>{Module.ccall('menu_on_password_reset_email_sent','v');},error=>{simpleAppErrorC(error.message);});}
function firebaseSignout(){firebaseAuth.signOut();}
function firebaseMerge(email,password,merge){if(merge){performApiRequest(`/user?m=${email}`,true).then(result=>{firebaseAuth.signInWithEmailAndPassword(email,password).then(result=>{},error=>{appErrorC(1005,error.message);});},error=>{appErrorC(1004,error);});}else{firebaseAuth.currentUser.delete().then(result=>{firebaseAuth.signInWithEmailAndPassword(email,password).then(result=>{},error=>{appErrorC(1007,error.message);});},error=>{appErrorC(1006,error.message);});}}
function objectIsEmpty(obj){return Object.keys(obj).length===0;}
function firebaseSignin(email,pwd){let c=firebase.auth.EmailAuthProvider.credential(email,pwd);firebaseAuth.currentUser.linkWithCredential(c).then(result=>{Module.ccall('set_user_state','v',['number'],[3]);Module.ccall('app_on_signin','v');},error=>{let anonUsedCode=3;let anonUnusedCode=4;if(error.code=="auth/email-already-in-use"){performApiRequest(`/user`,true).then(result=>{if(result&&!objectIsEmpty(result)){appErrorC(anonUsedCode,null);}else{appErrorC(anonUnusedCode,null);}},error=>{simpleAppErrorC("Wrong email or password");});}else{simpleAppErrorC(error.message+" "+error.code);}});}
function firebaseSigninAnonymous(){firebaseAuth.signInAnonymously().then(result=>{},error=>{appErrorC(1001,error.message);});}
let lastTokenRefreshTime=0;async function performRequest(url,useToken,parseJson){url=encodeURI(url);let idToken=null;if(useToken){var user=firebaseAuth.currentUser;if(user){let millis=Date.now();let refresh=millis-lastTokenRefreshTime>10*60*1000;if(refresh){lastTokenRefreshTime=millis;}
idToken=await user.getIdToken(refresh);}else{throw"error-no-user";}}
return new Promise((resolve,reject)=>{var xhr=new XMLHttpRequest();xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status!=200){reject("status-"+xhr.status);}else{if(parseJson){try{resolve(JSON.parse(xhr.response));}catch(err){resolve(null);}}else{resolve(xhr.response);}}}};xhr.onerror=function(){reject("error-xhr");};xhr.open("GET",url);if(useToken){xhr.setRequestHeader("Authorization",`Bearer ${idToken}`);}
xhr.send('');});}
async function performApiRequest(pathQuery,useToken){let apiHost;let hostName=window.location.hostname;if(hostName.startsWith("play.fancade.com")){apiHost="https://api.fancade.com";}else{apiHost=`http://${hostName}:5006`;}
let url=`${apiHost}${pathQuery}`;return performRequest(url,useToken,true);}
function getUserData(){performApiRequest(`/user`,true).then(userData=>{if(userData){let nick=userData.nick?userData.nick:null;Module.ccall('set_user_nick','v',['string'],[nick]);let gems=0;if(userData.gold){gems=userData.gold;}
Module.ccall('set_user_gems','v',['number'],[gems]);updateDailyRewardStatus(gems,true);let adfreeEnds=0;if(userData.noad){adfreeEnds=userData.noad;}
Module.ccall('set_user_adfree_ends','v',['number'],[adfreeEnds]);let userPremiumEnds=Module.ccall("get_user_premium_ends","number",[],[]);if(userData.premium){let premium30Seconds=30*24*60*60;let premiumStarts=userData.premium;let premiumEnds=premiumStarts+premium30Seconds;if(premiumEnds>userPremiumEnds){userPremiumEnds=premiumEnds;Module.ccall("set_user_premium_ends","v",["number"],[userPremiumEnds]);}}
if(userData.prem){let premiumEnds=userData.prem;if(premiumEnds>userPremiumEnds){userPremiumEnds=premiumEnds;Module.ccall("set_user_premium_ends","v",["number"],[userPremiumEnds]);}}
let userState=firebaseAuth.currentUser.isAnonymous?2:3;Module.ccall('set_user_state','v',['number'],[userState]);Module.ccall('set_user_uid','v',['string'],[firebaseAuth.currentUser.uid]);Module.ccall('app_on_signin','v');}else{Module.ccall('set_user_state','v',['number'],[1]);Module.ccall('app_on_signout','v');}},err=>{});}
function firebaseInit(){initFirebaseBasic();firebaseAnalytics=firebase.analytics(firebaseApp);firebaseRemoteConfig=firebase.remoteConfig(firebaseApp);firebaseAuth=firebase.auth(firebaseApp);firebaseAuth.onAuthStateChanged(function(user){if(user){getUserData();let sgGuid=getGameGuidString();if(sgGuid!=""){if(!singleGameReadCounts){firebaseReadCounts(0,sgGuid,true);}
if(!singleGameReadLedger){firebaseReadLedger(0,sgGuid);}}}else{Module.ccall('set_user_state','v',['number'],[1]);Module.ccall('app_on_signout','v');}});}
function writeGameBlob(blob,pathDevice,guid){blob.arrayBuffer().then(buffer=>{writeLocalFile(buffer,pathDevice);FS.syncfs(false,function(err){if(err){}
Module.ccall('game_download_finished',"v",["string","string","number"],[pathDevice,guid,1]);});});}
function firebaseDownload(pathServer,pathDevice,guid){let sref=firebaseStorage.ref(pathServer);if(guid==getGameGuidString()&&!pathDevice.endsWith('.webp')&&singleGameBlob!=null){writeGameBlob(singleGameBlob,pathDevice,guid);return;}
sref.getDownloadURL().then((url)=>{let xhr=new XMLHttpRequest();xhr.responseType='blob';xhr.onload=(event)=>{let blob=xhr.response;writeGameBlob(blob,pathDevice,guid);};xhr.onerror=function(){Module.ccall('game_download_finished',"v",["string","string","number"],[pathDevice,guid,0]);};xhr.open('GET',url);xhr.send();}).catch((error)=>{Module.ccall('game_download_finished',"v",["string","string","number"],[pathDevice,guid,0]);});}
function getVersion(time){return Math.round((time-Math.floor(time))*100000);}
function currentTimeSeconds(){return Math.round(Date.now()/1000);}
var nextIndex=[];function firebaseQueryGames(hi,heading,limit,next){while(nextIndex.length<=hi){nextIndex.push(0);}
let apiPath=`/list?l=${heading}`;if(!next)nextIndex[hi]=0;if(nextIndex[hi]){apiPath+=`&i=${nextIndex[hi]}`;}
performApiRequest(apiPath,true).then(doc=>{if(doc&&doc.g&&doc.g.length>0&&doc.v&&doc.v.length==doc.g.length){let gamesFetched=0;for(let i=0;i<doc.g.length;i++){let guid=doc.g[i];let sortOrder=doc.s[i];let version=doc.v[i];Module.ccall('menu_query_games_add_result','v',["number","string","number","number"],[hi,guid,sortOrder,version]);gamesFetched++;}
nextIndex[hi]+=gamesFetched;}
Module.ccall('menu_query_games_finished','v');},error=>{simpleAppErrorC(error);});}
function firebaseAnalyticsPlay(page,score,wi,guid,version,li,score_type,daily_done,game_time,crowns){let params={};if(page!=-1)
params["page"]=page;if(wi!=-1)
params["world"]=wi;params["guid"]=guid;if(version!=-1)
params["version"]=version;params["level"]=li;if(score_type!=0)
params["score"]=score;if(page==5)
params["daily"]=daily_done;if(game_time!=-1)
params["time"]=game_time/60;if(crowns!=-1)
params["crowns"]=crowns;firebaseAnalytics.logEvent("play",params);}
